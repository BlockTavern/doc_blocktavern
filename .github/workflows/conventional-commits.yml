# Conventional Commits è§„èŒƒå¤„ç†å’Œå˜æ›´æ—¥å¿—ç”Ÿæˆå·¥ä½œæµ
name: Conventional Commits & Changelog

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # éªŒè¯æäº¤ä¿¡æ¯æ ¼å¼
  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Conventional Commits
        uses: wagoid/commitlint-github-action@v5
        with:
          configFile: '.commitlintrc.json'

  # ç”Ÿæˆå˜æ›´æ—¥å¿—å’Œç‰ˆæœ¬æ ‡ç­¾
  changelog-and-release:
    name: Generate Changelog & Release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      new-release-published: ${{ steps.semantic-release.outputs.new-release-published }}
      new-release-version: ${{ steps.semantic-release.outputs.new-release-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: |
          npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github conventional-changelog-conventionalcommits

      - name: Create semantic-release config
        run: |
          cat > .releaserc.json << 'EOF'
          {
            "branches": ["main"],
            "plugins": [
              [
                "@semantic-release/commit-analyzer",
                {
                  "preset": "conventionalcommits",
                  "releaseRules": [
                    {"type": "feat", "release": "minor"},
                    {"type": "fix", "release": "patch"},
                    {"type": "perf", "release": "patch"},
                    {"type": "docs", "release": false},
                    {"type": "style", "release": false},
                    {"type": "refactor", "release": "patch"},
                    {"type": "test", "release": false},
                    {"type": "build", "release": "patch"},
                    {"type": "ci", "release": false},
                    {"type": "chore", "release": false}
                  ]
                }
              ],
              [
                "@semantic-release/release-notes-generator",
                {
                  "preset": "conventionalcommits",
                  "presetConfig": {
                    "types": [
                      {"type": "feat", "section": "âœ¨ æ–°åŠŸèƒ½", "hidden": false},
                      {"type": "fix", "section": "ğŸ› Bug ä¿®å¤", "hidden": false},
                      {"type": "perf", "section": "âš¡ æ€§èƒ½ä¼˜åŒ–", "hidden": false},
                      {"type": "refactor", "section": "â™»ï¸ ä»£ç é‡æ„", "hidden": false},
                      {"type": "docs", "section": "ğŸ“š æ–‡æ¡£æ›´æ–°", "hidden": false},
                      {"type": "style", "section": "ğŸ’„ ä»£ç æ ¼å¼", "hidden": true},
                      {"type": "test", "section": "âœ… æµ‹è¯•", "hidden": true},
                      {"type": "build", "section": "ğŸ“¦ æ„å»ºç³»ç»Ÿ", "hidden": false},
                      {"type": "ci", "section": "ğŸ‘· CI/CD", "hidden": true},
                      {"type": "chore", "section": "ğŸ”§ å…¶ä»–å˜æ›´", "hidden": true}
                    ]
                  }
                }
              ],
              [
                "@semantic-release/changelog",
                {
                  "changelogFile": "CHANGELOG.md",
                  "changelogTitle": "# ğŸ“‹ å˜æ›´æ—¥å¿—\n\næœ¬é¡¹ç›®çš„æ‰€æœ‰é‡è¦å˜æ›´éƒ½å°†è®°å½•åœ¨æ­¤æ–‡ä»¶ä¸­ã€‚\n\næ ¼å¼åŸºäº [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)ï¼Œ\nå¹¶ä¸”æœ¬é¡¹ç›®éµå¾ª [è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://semver.org/lang/zh-CN/) è§„èŒƒã€‚"
                }
              ],
              [
                "@semantic-release/git",
                {
                  "assets": ["CHANGELOG.md", "package.json"],
                  "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
                }
              ],
              "@semantic-release/github"
            ]
          }
          EOF

      - name: Create commitlint config
        run: |
          cat > .commitlintrc.json << 'EOF'
          {
            "extends": ["@commitlint/config-conventional"],
            "rules": {
              "type-enum": [
                2,
                "always",
                [
                  "feat",
                  "fix",
                  "docs",
                  "style",
                  "refactor",
                  "perf",
                  "test",
                  "build",
                  "ci",
                  "chore"
                ]
              ],
              "type-case": [2, "always", "lower-case"],
              "type-empty": [2, "never"],
              "scope-case": [2, "always", "lower-case"],
              "subject-case": [2, "never", ["sentence-case", "start-case", "pascal-case", "upper-case"]],
              "subject-empty": [2, "never"],
              "subject-full-stop": [2, "never", "."],
              "header-max-length": [2, "always", 100]
            }
          }
          EOF

      - name: Run semantic-release
        id: semantic-release
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç”Ÿæˆ Git å†å²æ•°æ®æ–‡ä»¶ï¼ˆè§£å†³éƒ¨ç½²åæ— æ³•è·å–æœ¬åœ°å†å²çš„é—®é¢˜ï¼‰
  generate-git-history:
    name: Generate Git History Data
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Generate Git History JSON
        run: |
          # åˆ›å»º git å†å²æ•°æ®ç”Ÿæˆè„šæœ¬
          cat > generate-git-history.js << 'EOF'
          const { execSync } = require('child_process');
          const fs = require('fs');
          const path = require('path');
          
          // è·å–æ‰€æœ‰æ–‡ä»¶çš„ git å†å²
          function getFileHistory(filePath) {
            try {
              const gitLog = execSync(
                `git log --follow --pretty=format:"%H|%an|%ae|%ad|%s" --date=iso -- "${filePath}"`,
                { encoding: 'utf8' }
              );
              
              if (!gitLog.trim()) return [];
              
              return gitLog.trim().split('\n').map(line => {
                const [hash, authorName, authorEmail, date, message] = line.split('|');
                return {
                  hash,
                  authorName,
                  authorEmail,
                  date,
                  message
                };
              });
            } catch (error) {
              console.error(`Error getting history for ${filePath}:`, error.message);
              return [];
            }
          }
          
          // è·å–æ‰€æœ‰ .md æ–‡ä»¶
          function getAllMarkdownFiles(dir, fileList = []) {
            const files = fs.readdirSync(dir);
            
            files.forEach(file => {
              const filePath = path.join(dir, file);
              const stat = fs.statSync(filePath);
              
              if (stat.isDirectory() && !file.startsWith('.') && file !== 'node_modules') {
                getAllMarkdownFiles(filePath, fileList);
              } else if (file.endsWith('.md')) {
                fileList.push(filePath);
              }
            });
            
            return fileList;
          }
          
          // ç”Ÿæˆå†å²æ•°æ®
          const docsDir = './docs';
          const markdownFiles = getAllMarkdownFiles(docsDir);
          const gitHistoryData = {};
          
          console.log(`Found ${markdownFiles.length} markdown files`);
          
          markdownFiles.forEach(filePath => {
            const relativePath = path.relative('.', filePath).replace(/\\/g, '/');
            const history = getFileHistory(relativePath);
            
            if (history.length > 0) {
              gitHistoryData[relativePath] = {
                history,
                lastUpdated: history[0]?.date || null
              };
              console.log(`Generated history for ${relativePath}: ${history.length} commits`);
            }
          });
          
          // ä¿å­˜åˆ° JSON æ–‡ä»¶
          const outputPath = './docs/public/git-history.json';
          fs.mkdirSync(path.dirname(outputPath), { recursive: true });
          fs.writeFileSync(outputPath, JSON.stringify(gitHistoryData, null, 2));
          
          console.log(`Git history data saved to ${outputPath}`);
          console.log(`Total files with history: ${Object.keys(gitHistoryData).length}`);
          EOF
          
          # è¿è¡Œè„šæœ¬ç”Ÿæˆå†å²æ•°æ®
          node generate-git-history.js

      - name: Commit and push git history data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -f "docs/public/git-history.json" ]; then
            git add docs/public/git-history.json
            if git diff --staged --quiet; then
              echo "No changes to git history data"
            else
              git commit -m "chore: update git history data [skip ci]"
              git push
            fi
          fi

  # ç¾åŒ–æäº¤ä¿¡æ¯ï¼ˆä¸ºä¸è§„èŒƒçš„æäº¤æ·»åŠ ç±»å‹å‰ç¼€ï¼‰
  beautify-commits:
    name: Beautify Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Beautify commit messages
        run: |
          # åˆ›å»ºæäº¤ä¿¡æ¯ç¾åŒ–è„šæœ¬
          cat > beautify-commits.js << 'EOF'
          const { execSync } = require('child_process');
          
          // è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯
          function getRecentCommits(count = 10) {
            try {
              const gitLog = execSync(
                `git log --oneline -n ${count} --pretty=format:"%H %s"`,
                { encoding: 'utf8' }
              );
              
              return gitLog.trim().split('\n').map(line => {
                const [hash, ...messageParts] = line.split(' ');
                return {
                  hash,
                  message: messageParts.join(' ')
                };
              });
            } catch (error) {
              console.error('Error getting commits:', error.message);
              return [];
            }
          }
          
          // æ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦ç¬¦åˆ Conventional Commits è§„èŒƒ
          function isConventionalCommit(message) {
            const conventionalPattern = /^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\(.+\))?!?:\s.+/;
            return conventionalPattern.test(message);
          }
          
          // æ ¹æ®æäº¤å†…å®¹æ¨æ–­ç±»å‹
          function inferCommitType(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('add') || lowerMessage.includes('æ–°å¢') || lowerMessage.includes('æ·»åŠ ')) {
              return 'feat';
            }
            if (lowerMessage.includes('fix') || lowerMessage.includes('ä¿®å¤') || lowerMessage.includes('è§£å†³')) {
              return 'fix';
            }
            if (lowerMessage.includes('doc') || lowerMessage.includes('æ–‡æ¡£') || lowerMessage.includes('readme')) {
              return 'docs';
            }
            if (lowerMessage.includes('style') || lowerMessage.includes('æ ¼å¼') || lowerMessage.includes('æ ·å¼')) {
              return 'style';
            }
            if (lowerMessage.includes('refactor') || lowerMessage.includes('é‡æ„') || lowerMessage.includes('ä¼˜åŒ–ä»£ç ')) {
              return 'refactor';
            }
            if (lowerMessage.includes('perf') || lowerMessage.includes('æ€§èƒ½') || lowerMessage.includes('ä¼˜åŒ–')) {
              return 'perf';
            }
            if (lowerMessage.includes('test') || lowerMessage.includes('æµ‹è¯•')) {
              return 'test';
            }
            if (lowerMessage.includes('build') || lowerMessage.includes('æ„å»º') || lowerMessage.includes('ä¾èµ–')) {
              return 'build';
            }
            if (lowerMessage.includes('ci') || lowerMessage.includes('workflow') || lowerMessage.includes('action')) {
              return 'ci';
            }
            
            return 'chore';
          }
          
          // ç¾åŒ–æäº¤ä¿¡æ¯
          function beautifyCommitMessage(message) {
            if (isConventionalCommit(message)) {
              return message; // å·²ç»ç¬¦åˆè§„èŒƒ
            }
            
            const type = inferCommitType(message);
            const cleanMessage = message.replace(/^(add|fix|update|modify|change)\s*/i, '').trim();
            
            return `${type}: ${cleanMessage}`;
          }
          
          console.log('Analyzing recent commits for beautification opportunities...');
          const commits = getRecentCommits(20);
          
          commits.forEach(commit => {
            const beautified = beautifyCommitMessage(commit.message);
            if (beautified !== commit.message) {
              console.log(`\nğŸ“ Commit: ${commit.hash.substring(0, 7)}`);
              console.log(`   Original: ${commit.message}`);
              console.log(`   Beautified: ${beautified}`);
            }
          });
          
          console.log('\nâœ¨ Commit message analysis complete!');
          console.log('\nğŸ’¡ Tips for future commits:');
          console.log('   feat: æ–°åŠŸèƒ½');
          console.log('   fix: ä¿®å¤ bug');
          console.log('   docs: æ–‡æ¡£æ›´æ–°');
          console.log('   style: ä»£ç æ ¼å¼è°ƒæ•´');
          console.log('   refactor: ä»£ç é‡æ„');
          console.log('   perf: æ€§èƒ½ä¼˜åŒ–');
          console.log('   test: æµ‹è¯•ç›¸å…³');
          console.log('   build: æ„å»ºç›¸å…³');
          console.log('   ci: CI/CD ç›¸å…³');
          console.log('   chore: å…¶ä»–å˜æ›´');
          EOF
          
          # è¿è¡Œç¾åŒ–è„šæœ¬
          node beautify-commits.js