# ä¸»å·¥ä½œæµ - åè°ƒæ‰€æœ‰ Conventional Commits ç›¸å…³ä»»åŠ¡
name: Main Workflow

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'å¼ºåˆ¶åˆ›å»ºå‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean
      update_history:
        description: 'å¼ºåˆ¶æ›´æ–° Git å†å²æ•°æ®'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  # PR æ—¶éªŒè¯æäº¤ä¿¡æ¯
  validate-commits:
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/validate-commits.yml
    permissions:
      contents: read
      pull-requests: write

  # å‘å¸ƒç‰ˆæœ¬å’Œæ›´æ–° Git å†å²ï¼ˆåˆå¹¶ä»»åŠ¡ï¼Œæ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼‰
  release-and-history:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.force_release == 'true' || github.event.inputs.update_history == 'true'))
    runs-on: ubuntu-latest
    name: Release and History
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      
      - name: Check for changes
        id: changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„ä»£ç å˜æ›´ï¼ˆæ’é™¤å·¥ä½œæµæ–‡ä»¶å’Œè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼‰
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -v '^.github/workflows/' | grep -v '^docs/public/git-history.json$' | wc -l)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "ğŸ“Š æ£€æµ‹åˆ° $CHANGED_FILES ä¸ªéå·¥ä½œæµæ–‡ä»¶å˜æ›´"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æ¡£å˜æ›´
          DOC_CHANGES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(md|vue|js|ts|json)$' | grep -v '^docs/public/git-history.json$' | wc -l)
          echo "doc_changes=$DOC_CHANGES" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ° $DOC_CHANGES ä¸ªæ–‡æ¡£ç›¸å…³æ–‡ä»¶å˜æ›´"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®æ–‡ä»¶å˜æ›´
          CONFIG_CHANGES=$(git diff --name-only HEAD~1 HEAD | grep -E '(package\.json|vitepress|config\.)' | wc -l)
          echo "config_changes=$CONFIG_CHANGES" >> $GITHUB_OUTPUT
          echo "âš™ï¸ æ£€æµ‹åˆ° $CONFIG_CHANGES ä¸ªé…ç½®æ–‡ä»¶å˜æ›´"
          
          # æ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦åŒ…å« [skip ci] æˆ– [skip history]
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -q '\[skip ci\]'; then
            echo "skip_ci=true" >> $GITHUB_OUTPUT
            echo "â­ï¸ æ£€æµ‹åˆ° [skip ci] æ ‡è®°ï¼Œå°†è·³è¿‡CIä»»åŠ¡"
          else
            echo "skip_ci=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$COMMIT_MSG" | grep -q '\[skip history\]'; then
            echo "skip_history=true" >> $GITHUB_OUTPUT
            echo "â­ï¸ æ£€æµ‹åˆ° [skip history] æ ‡è®°ï¼Œå°†è·³è¿‡å†å²æ›´æ–°"
          else
            echo "skip_history=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        if: |
          (github.event_name == 'push' && steps.changes.outputs.changed_files > 0 && steps.changes.outputs.skip_ci == 'false') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.force_release == 'true')
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_release }}" = "true" ]; then
            echo "ğŸš€ æ‰‹åŠ¨è§¦å‘ç‰ˆæœ¬å‘å¸ƒå·¥ä½œæµ"
            gh workflow run release.yml --field release_type=patch
          else
            echo "ğŸš€ è§¦å‘ç‰ˆæœ¬å‘å¸ƒå·¥ä½œæµ"
            gh workflow run release.yml
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate Git History
        if: |
          (github.event_name == 'push' && steps.changes.outputs.doc_changes > 0 && steps.changes.outputs.skip_history == 'false') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.update_history == 'true')
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.update_history }}" = "true" ]; then
            echo "ğŸ“Š æ‰‹åŠ¨è§¦å‘ Git å†å²æ•°æ®ç”Ÿæˆ..."
          else
            echo "ğŸ“Š å¼€å§‹ç”Ÿæˆ Git å†å²æ•°æ®..."
          fi
           
           # åˆ›å»º git å†å²æ•°æ®ç”Ÿæˆè„šæœ¬
           cat > generate-git-history.js << 'EOF'
           const { execSync } = require('child_process');
           const fs = require('fs');
           const path = require('path');
           
           console.log('ğŸš€ å¼€å§‹ç”Ÿæˆ Git å†å²æ•°æ®...');
           
           // è·å–æ‰€æœ‰æ–‡ä»¶çš„ git å†å²
           function getFileHistory(filePath) {
             try {
               const gitLog = execSync(
                 `git log --follow --pretty=format:"%H|%an|%ae|%ad|%s" --date=iso -- "${filePath}"`,
                 { encoding: 'utf8' }
               );
               
               if (!gitLog.trim()) return [];
               
               return gitLog.trim().split('\n').map(line => {
                 const [hash, authorName, authorEmail, date, message] = line.split('|');
                 return {
                   hash,
                   authorName,
                   authorEmail,
                   date,
                   message
                 };
               });
             } catch (error) {
               console.error(`âŒ è·å– ${filePath} å†å²å¤±è´¥:`, error.message);
               return [];
             }
           }
           
           // è·å–æ‰€æœ‰ .md æ–‡ä»¶
           function getAllMarkdownFiles(dir, fileList = []) {
             const files = fs.readdirSync(dir);
             
             files.forEach(file => {
               const filePath = path.join(dir, file);
               const stat = fs.statSync(filePath);
               
               if (stat.isDirectory() && !file.startsWith('.') && file !== 'node_modules') {
                 getAllMarkdownFiles(filePath, fileList);
               } else if (file.endsWith('.md')) {
                 fileList.push(filePath);
               }
             });
             
             return fileList;
           }
           
           // è·å–ä»“åº“ç»Ÿè®¡ä¿¡æ¯
           function getRepoStats() {
             try {
               const totalCommits = execSync('git rev-list --all --count', { encoding: 'utf8' }).trim();
               const contributors = execSync('git log --format="%an" | sort -u | wc -l', { encoding: 'utf8' }).trim();
               const firstCommit = execSync('git log --reverse --format="%ad" --date=iso | head -1', { encoding: 'utf8' }).trim();
               const lastCommit = execSync('git log -1 --format="%ad" --date=iso', { encoding: 'utf8' }).trim();
               
               return {
                 totalCommits: parseInt(totalCommits),
                 contributors: parseInt(contributors),
                 firstCommit,
                 lastCommit,
                 generatedAt: new Date().toISOString()
               };
             } catch (error) {
               console.error('âŒ è·å–ä»“åº“ç»Ÿè®¡å¤±è´¥:', error.message);
               return {
                 totalCommits: 0,
                 contributors: 0,
                 firstCommit: null,
                 lastCommit: null,
                 generatedAt: new Date().toISOString()
               };
             }
           }
           
           // ç”Ÿæˆå†å²æ•°æ®
           const docsDir = './docs';
           const markdownFiles = getAllMarkdownFiles(docsDir);
           const gitHistoryData = {
             _meta: getRepoStats(),
             files: {}
           };
           
           console.log(`ğŸ“ å‘ç° ${markdownFiles.length} ä¸ª Markdown æ–‡ä»¶`);
           
           markdownFiles.forEach(file => {
             const relativePath = path.relative('.', file).replace(/\\/g, '/');
             const history = getFileHistory(file);
             
             if (history.length > 0) {
               gitHistoryData.files[relativePath] = {
                 history,
                 lastUpdated: history[0].date,
                 totalCommits: history.length,
                 contributors: [...new Set(history.map(h => h.authorName))].length
               };
               console.log(`âœ… ${relativePath}: ${history.length} æ¬¡æäº¤`);
             } else {
               console.log(`âš ï¸ ${relativePath}: æ— å†å²è®°å½•`);
             }
           });
           
           // å†™å…¥æ–‡ä»¶
           const outputPath = './docs/public/git-history.json';
           fs.writeFileSync(outputPath, JSON.stringify(gitHistoryData, null, 2));
           
           console.log(`âœ… Git å†å²æ•°æ®å·²ç”Ÿæˆ: ${outputPath}`);
           console.log(`ğŸ“Š ç»Ÿè®¡: ${Object.keys(gitHistoryData.files).length} ä¸ªæ–‡ä»¶, ${gitHistoryData._meta.totalCommits} æ¬¡æäº¤`);
           
           // éªŒè¯ç”Ÿæˆçš„JSONæ–‡ä»¶
           try {
             const jsonContent = fs.readFileSync(outputPath, 'utf8');
             const parsedData = JSON.parse(jsonContent);
             console.log('âœ… JSON æ–‡ä»¶æ ¼å¼éªŒè¯é€šè¿‡');
             
             // éªŒè¯æ•°æ®ç»“æ„
             if (!parsedData._meta || !parsedData.files) {
               throw new Error('ç¼ºå°‘å¿…è¦çš„æ•°æ®ç»“æ„ (_meta æˆ– files)');
             }
             
             // éªŒè¯å…ƒæ•°æ®
             const meta = parsedData._meta;
             if (typeof meta.totalCommits !== 'number' || meta.totalCommits < 0) {
               throw new Error('æ— æ•ˆçš„ totalCommits å€¼');
             }
             
             if (typeof meta.contributors !== 'number' || meta.contributors < 0) {
               throw new Error('æ— æ•ˆçš„ contributors å€¼');
             }
             
             if (!meta.generatedAt || !Date.parse(meta.generatedAt)) {
               throw new Error('æ— æ•ˆçš„ generatedAt æ—¶é—´æˆ³');
             }
             
             // éªŒè¯æ–‡ä»¶æ•°æ®
             const fileCount = Object.keys(parsedData.files).length;
             console.log(`ğŸ“Š éªŒè¯ ${fileCount} ä¸ªæ–‡ä»¶çš„å†å²æ•°æ®`);
             
             let validFiles = 0;
             for (const [filePath, fileData] of Object.entries(parsedData.files)) {
               if (!fileData.history || !Array.isArray(fileData.history)) {
                 console.warn(`âš ï¸ æ–‡ä»¶ ${filePath} ç¼ºå°‘æœ‰æ•ˆçš„ history æ•°ç»„`);
                 continue;
               }
               
               if (!fileData.lastUpdated || !fileData.totalCommits) {
                 console.warn(`âš ï¸ æ–‡ä»¶ ${filePath} ç¼ºå°‘å¿…è¦å­—æ®µ`);
                 continue;
               }
               
               // éªŒè¯å†å²è®°å½•æ ¼å¼
               for (const commit of fileData.history) {
                 if (!commit.hash || !commit.authorName || !commit.date || !commit.message) {
                   console.warn(`âš ï¸ æ–‡ä»¶ ${filePath} åŒ…å«æ— æ•ˆçš„æäº¤è®°å½•`);
                   break;
                 }
               }
               
               validFiles++;
             }
             
             console.log(`âœ… æ•°æ®ç»“æ„éªŒè¯é€šè¿‡: ${validFiles}/${fileCount} ä¸ªæ–‡ä»¶æœ‰æ•ˆ`);
             
             // æ£€æŸ¥æ–‡ä»¶å¤§å°
             const fileSizeKB = Math.round(jsonContent.length / 1024);
             console.log(`ğŸ“ æ–‡ä»¶å¤§å°: ${fileSizeKB} KB`);
             
             if (fileSizeKB > 5000) {
               console.warn('âš ï¸ æ–‡ä»¶å¤§å°è¶…è¿‡ 5MBï¼Œå¯èƒ½å½±å“åŠ è½½æ€§èƒ½');
             }
             
           } catch (error) {
             console.error('âŒ JSON æ–‡ä»¶éªŒè¯å¤±è´¥:', error.message);
             process.exit(1);
           }
           EOF
           
           # æ‰§è¡Œè„šæœ¬
           node generate-git-history.js
           
           # æäº¤æ›´æ–°çš„å†å²æ–‡ä»¶
           git config --local user.email "action@github.com"
           git config --local user.name "GitHub Action"
           
           if [ -f "docs/public/git-history.json" ]; then
             if git diff --quiet docs/public/git-history.json; then
               echo "ğŸ“ Git å†å²æ•°æ®æ— å˜æ›´"
             else
               git add docs/public/git-history.json
               git commit -m "chore: æ›´æ–° Git å†å²æ•°æ® [skip ci]"
               
               # å…ˆæ‹‰å–è¿œç¨‹æ›´æ–°ï¼Œé¿å…å†²çª
               git pull --rebase origin main || {
                 echo "âš ï¸ æ‹‰å–è¿œç¨‹æ›´æ–°å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¨é€"
                 git push --force-with-lease origin main
               } && git push origin main
               
               echo "âœ… Git å†å²æ•°æ®å·²æ›´æ–°å¹¶æ¨é€"
             fi
           else
             echo "âŒ Git å†å²æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
             exit 1
           fi

  # æ„å»ºå’Œéƒ¨ç½²åˆ° GitHub Pagesï¼ˆåˆå¹¶ä»»åŠ¡ï¼‰
  build-and-deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [release-and-history]
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    name: Build and Deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check for deployment changes
        id: deploy_changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é‡æ–°éƒ¨ç½²çš„å˜æ›´
          DEPLOY_CHANGES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(md|vue|js|ts|json|css|scss)$|^docs/' | grep -v '^docs/public/git-history.json$' | wc -l)
          echo "deploy_changes=$DEPLOY_CHANGES" >> $GITHUB_OUTPUT
          echo "ğŸ” æ£€æµ‹åˆ° $DEPLOY_CHANGES ä¸ªéœ€è¦é‡æ–°éƒ¨ç½²çš„æ–‡ä»¶å˜æ›´"
          
          # æ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦åŒ…å« [skip deploy]
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -q '\[skip deploy\]'; then
            echo "skip_deploy=true" >> $GITHUB_OUTPUT
            echo "â­ï¸ æ£€æµ‹åˆ° [skip deploy] æ ‡è®°ï¼Œå°†è·³è¿‡éƒ¨ç½²"
          else
            echo "skip_deploy=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Setup Node
        if: steps.deploy_changes.outputs.deploy_changes > 0 && steps.deploy_changes.outputs.skip_deploy == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          
      - name: Setup Pages
        if: steps.deploy_changes.outputs.deploy_changes > 0 && steps.deploy_changes.outputs.skip_deploy == 'false'
        uses: actions/configure-pages@v4
        
      - name: Install dependencies
        if: steps.deploy_changes.outputs.deploy_changes > 0 && steps.deploy_changes.outputs.skip_deploy == 'false'
        run: npm ci
        
      - name: Build with VitePress
        if: steps.deploy_changes.outputs.deploy_changes > 0 && steps.deploy_changes.outputs.skip_deploy == 'false'
        run: npm run docs:build
        
      - name: Upload artifact
        if: steps.deploy_changes.outputs.deploy_changes > 0 && steps.deploy_changes.outputs.skip_deploy == 'false'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist
          
      - name: Deploy to GitHub Pages
        if: steps.deploy_changes.outputs.deploy_changes > 0 && steps.deploy_changes.outputs.skip_deploy == 'false'
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Skip deployment notice
        if: steps.deploy_changes.outputs.deploy_changes == 0 || steps.deploy_changes.outputs.skip_deploy == 'true'
        run: |
          if [ "${{ steps.deploy_changes.outputs.skip_deploy }}" = "true" ]; then
            echo "â­ï¸ éƒ¨ç½²å·²è·³è¿‡ï¼šæ£€æµ‹åˆ° [skip deploy] æ ‡è®°"
          else
            echo "â­ï¸ éƒ¨ç½²å·²è·³è¿‡ï¼šæ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦é‡æ–°éƒ¨ç½²çš„æ–‡ä»¶å˜æ›´"
          fi

  # æ±‡æ€»æŠ¥å‘Š
  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [validate-commits, release-and-history, build-and-deploy]
    steps:
      - name: Generate workflow summary
        run: |
          echo "## ğŸš€ å·¥ä½œæµæ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ æ‰§è¡Œçš„ä»»åŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "- âœ… æäº¤ä¿¡æ¯éªŒè¯: ${{ needs.validate-commits.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "- ğŸ·ï¸ ç‰ˆæœ¬å‘å¸ƒå’Œå†å²æ›´æ–°: ${{ needs.release-and-history.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ—ï¸ ç«™ç‚¹æ„å»ºå’Œéƒ¨ç½²: ${{ needs.build-and-deploy.result }}" >> $GITHUB_STEP_SUMMARY
            
            # æ˜¾ç¤ºæ™ºèƒ½è·³è¿‡æœºåˆ¶çš„æ‰§è¡Œæƒ…å†µ
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ§  æ™ºèƒ½è·³è¿‡æœºåˆ¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æœ¬æ¬¡æ¨é€çš„æ™ºèƒ½åˆ†æç»“æœï¼š" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š æ–‡ä»¶å˜æ›´æ£€æµ‹ï¼šè‡ªåŠ¨è¯†åˆ«éœ€è¦å¤„ç†çš„æ–‡ä»¶ç±»å‹" >> $GITHUB_STEP_SUMMARY
            echo "- â­ï¸ è·³è¿‡æ ‡è®°æ£€æµ‹ï¼šæ”¯æŒ [skip ci]ã€[skip history]ã€[skip deploy] æ ‡è®°" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ¯ æ¡ä»¶æ‰§è¡Œï¼šä»…åœ¨æœ‰å®é™…å˜æ›´æ—¶æ‰§è¡Œç›¸åº”ä»»åŠ¡" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "- ğŸ·ï¸ ç‰ˆæœ¬å‘å¸ƒå’Œå†å²æ›´æ–° (æ‰‹åŠ¨è§¦å‘): ${{ needs.release-and-history.result }}" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.force_release }}" = "true" ]; then
              echo "  - ğŸš€ å¼ºåˆ¶å‘å¸ƒç‰ˆæœ¬å·²å¯ç”¨" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "${{ github.event.inputs.update_history }}" = "true" ]; then
              echo "  - ğŸ“Š å¼ºåˆ¶æ›´æ–°å†å²å·²å¯ç”¨" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“š ç›¸å…³æ–‡æ¡£" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Conventional Commits è§„èŒƒæŒ‡å—](./CONVENTIONAL_COMMITS.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [é¡¹ç›®å˜æ›´æ—¥å¿—](./CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [æœ€æ–°å‘å¸ƒç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases/latest)" >> $GITHUB_STEP_SUMMARY