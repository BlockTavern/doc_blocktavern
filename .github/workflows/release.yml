# è‡ªåŠ¨ç‰ˆæœ¬å‘å¸ƒå·¥ä½œæµ
name: Release

on:
  workflow_call:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: false
        default: 'auto'
        type: string
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      new-release-published: ${{ steps.semantic-release.outputs.new-release-published }}
      new-release-version: ${{ steps.semantic-release.outputs.new-release-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install semantic-release
        run: |
          npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github conventional-changelog-conventionalcommits

      - name: Create semantic-release config
        run: |
          cat > .releaserc.json << 'EOF'
          {
            "branches": ["main"],
            "plugins": [
              [
                "@semantic-release/commit-analyzer",
                {
                  "preset": "conventionalcommits",
                  "releaseRules": [
                    {"type": "feat", "release": "minor"},
                    {"type": "fix", "release": "patch"},
                    {"type": "perf", "release": "patch"},
                    {"type": "docs", "release": false},
                    {"type": "style", "release": false},
                    {"type": "refactor", "release": "patch"},
                    {"type": "test", "release": false},
                    {"type": "build", "release": "patch"},
                    {"type": "ci", "release": false},
                    {"type": "chore", "release": false},
                    {"breaking": true, "release": "major"}
                  ]
                }
              ],
              [
                "@semantic-release/release-notes-generator",
                {
                  "preset": "conventionalcommits",
                  "presetConfig": {
                    "types": [
                      {"type": "feat", "section": "âœ¨ æ–°åŠŸèƒ½", "hidden": false},
                      {"type": "fix", "section": "ğŸ› Bug ä¿®å¤", "hidden": false},
                      {"type": "perf", "section": "âš¡ æ€§èƒ½ä¼˜åŒ–", "hidden": false},
                      {"type": "refactor", "section": "â™»ï¸ ä»£ç é‡æ„", "hidden": false},
                      {"type": "docs", "section": "ğŸ“š æ–‡æ¡£æ›´æ–°", "hidden": false},
                      {"type": "style", "section": "ğŸ’„ ä»£ç æ ¼å¼", "hidden": true},
                      {"type": "test", "section": "âœ… æµ‹è¯•", "hidden": true},
                      {"type": "build", "section": "ğŸ“¦ æ„å»ºç³»ç»Ÿ", "hidden": false},
                      {"type": "ci", "section": "ğŸ‘· CI/CD", "hidden": true},
                      {"type": "chore", "section": "ğŸ”§ å…¶ä»–å˜æ›´", "hidden": true}
                    ]
                  }
                }
              ],
              [
                "@semantic-release/changelog",
                {
                  "changelogFile": "CHANGELOG.md",
                  "changelogTitle": "# ğŸ“‹ å˜æ›´æ—¥å¿—\n\næœ¬é¡¹ç›®çš„æ‰€æœ‰é‡è¦å˜æ›´éƒ½å°†è®°å½•åœ¨æ­¤æ–‡ä»¶ä¸­ã€‚\n\næ ¼å¼åŸºäº [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)ï¼Œ\nå¹¶ä¸”æœ¬é¡¹ç›®éµå¾ª [è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://semver.org/lang/zh-CN/) è§„èŒƒã€‚"
                }
              ],
              [
                "@semantic-release/git",
                {
                  "assets": ["CHANGELOG.md", "package.json"],
                  "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
                }
              ],
              "@semantic-release/github"
            ]
          }
          EOF

      - name: Check for releasable commits
        id: check-commits
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å¯å‘å¸ƒçš„æäº¤
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No previous tags found, will create initial release"
            echo "has-releasable-commits=true" >> $GITHUB_OUTPUT
          else
            # æ£€æŸ¥è‡ªä¸Šæ¬¡æ ‡ç­¾ä»¥æ¥æ˜¯å¦æœ‰ feat, fix, perf, refactor, build ç±»å‹çš„æäº¤
            RELEASABLE_COMMITS=$(git log $LAST_TAG..HEAD --oneline --grep="^feat" --grep="^fix" --grep="^perf" --grep="^refactor" --grep="^build" --grep="BREAKING CHANGE" -E)
            if [ -n "$RELEASABLE_COMMITS" ]; then
              echo "Found releasable commits:"
              echo "$RELEASABLE_COMMITS"
              echo "has-releasable-commits=true" >> $GITHUB_OUTPUT
            else
              echo "No releasable commits found since last tag"
              echo "has-releasable-commits=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run semantic-release
        id: semantic-release
        if: steps.check-commits.outputs.has-releasable-commits == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.release_type }}" != "auto" ] && [ "${{ github.event.inputs.release_type }}" != "" ]; then
            # æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬ç±»å‹
            npx semantic-release --debug
          else
            # è‡ªåŠ¨åˆ†æç‰ˆæœ¬ç±»å‹
            npx semantic-release
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release info
        if: steps.semantic-release.outputs.new-release-published == 'true'
        run: |
          echo "ğŸ‰ æ–°ç‰ˆæœ¬å·²å‘å¸ƒ: ${{ steps.semantic-release.outputs.new-release-version }}"
          echo "ğŸ“‹ æŸ¥çœ‹å‘å¸ƒè¯¦æƒ…: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.semantic-release.outputs.new-release-version }}"

      - name: No release needed
        if: steps.check-commits.outputs.has-releasable-commits == 'false' && github.event_name != 'workflow_dispatch'
        run: |
          echo "â„¹ï¸ æ²¡æœ‰éœ€è¦å‘å¸ƒçš„æ›´æ”¹ã€‚åªæœ‰ä»¥ä¸‹ç±»å‹çš„æäº¤ä¼šè§¦å‘ç‰ˆæœ¬å‘å¸ƒï¼š"
          echo "  - feat: æ–°åŠŸèƒ½ (minor ç‰ˆæœ¬)"
          echo "  - fix: Bug ä¿®å¤ (patch ç‰ˆæœ¬)"
          echo "  - perf: æ€§èƒ½ä¼˜åŒ– (patch ç‰ˆæœ¬)"
          echo "  - refactor: ä»£ç é‡æ„ (patch ç‰ˆæœ¬)"
          echo "  - build: æ„å»ºç›¸å…³ (patch ç‰ˆæœ¬)"
          echo "  - BREAKING CHANGE: ç ´åæ€§å˜æ›´ (major ç‰ˆæœ¬)"